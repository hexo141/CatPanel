name: Build catpanel

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact: catpanel-linux
          - os: windows-latest
            artifact: catpanel-windows
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - run: pip install nuitka
    
    - name: Build
      run: |
        python -m nuitka \
          --standalone \
          --output-dir=dist \
          --remove-output \
          --show-progress \
          --assume-yes-for-downloads \
          --include-data-files=config/*=config/ \
          --include-data-files=templates/*=templates/ \
          --include-data-files=static/*=static/ \
          --include-data-files=*.md=. \
          --include-data-files=*.txt=. \
          catpanel/main.py
    
    - name: Package
      run: |
        cd dist
        find . -name "*.dist" -type d -exec zip -r ../${{ matrix.artifact }}.zip {} \;
    
    - uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: ${{ matrix.artifact }}.zip
